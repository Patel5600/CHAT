import express, { Express, Request, Response, NextFunction } from 'express';\nimport cors from 'cors';\nimport dotenv from 'dotenv';\nimport { createClient } from '@supabase/supabase-js';\nimport { v4 as uuidv4 } from 'uuid';\n\ndotenv.config();\n\nconst app: Express = express();\nconst port = process.env.PORT || 3000;\n\n// Middleware\napp.use(cors());\napp.use(express.json());\n\n// Supabase client\nconst supabaseUrl = process.env.SUPABASE_URL || '';\nconst supabaseKey = process.env.SUPABASE_KEY || '';\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\n// Types\ninterface OTPRequest {\n  email: string;\n}\n\ninterface OTPVerifyRequest {\n  email: string;\n  otp: string;\n}\n\ninterface MessageRequest {\n  recipientId: string;\n  ciphertext: string;\n  nonce: string;\n  ephemeralKey: string;\n  messageHash: string;\n}\n\ninterface SealRequest {\n  messageCount: number;\n  merkleRoot: string;\n  messageHashes: string[];\n  signature: string;\n}\n\n// Error handler middleware\napp.use((err: Error, req: Request, res: Response, next: NextFunction) => {\n  console.error('Error:', err);\n  res.status(500).json({ error: err.message });\n});\n\n// Health check\napp.get('/health', (req: Request, res: Response) => {\n  res.json({ status: 'ok', timestamp: new Date().toISOString() });\n});\n\n// Send OTP\napp.post('/api/auth/send-otp', async (req: Request, res: Response) => {\n  try {\n    const { email } = req.body as OTPRequest;\n\n    if (!email) {\n      return res.status(400).json({ error: 'Email is required' });\n    }\n\n    // Generate OTP\n    const otp = Math.floor(100000 + Math.random() * 900000).toString();\n    const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes\n\n    // Store OTP in Supabase\n    const { data, error } = await supabase\n      .from('otps')\n      .insert([\n        {\n          email,\n          otp,\n          expires_at: expiresAt.toISOString(),\n          created_at: new Date().toISOString(),\n        },\n      ]);\n\n    if (error) {\n      console.error('Supabase error:', error);\n      return res.status(500).json({ error: 'Failed to send OTP' });\n    }\n\n    // In production, send OTP via email\n    console.log(`OTP for ${email}: ${otp}`);\n\n    res.json({ message: 'OTP sent successfully' });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Verify OTP\napp.post('/api/auth/verify-otp', async (req: Request, res: Response) => {\n  try {\n    const { email, otp } = req.body as OTPVerifyRequest;\n\n    if (!email || !otp) {\n      return res.status(400).json({ error: 'Email and OTP are required' });\n    }\n\n    // Verify OTP\n    const { data: otpData, error: otpError } = await supabase\n      .from('otps')\n      .select('*')\n      .eq('email', email)\n      .eq('otp', otp)\n      .gt('expires_at', new Date().toISOString())\n      .order('created_at', { ascending: false })\n      .limit(1);\n\n    if (otpError || !otpData || otpData.length === 0) {\n      return res.status(401).json({ error: 'Invalid or expired OTP' });\n    }\n\n    // Get or create user\n    let { data: userData, error: userError } = await supabase\n      .from('users')\n      .select('*')\n      .eq('email', email);\n\n    if (userError) {\n      return res.status(500).json({ error: 'Database error' });\n    }\n\n    let userId: string;\n\n    if (!userData || userData.length === 0) {\n      // Create new user\n      const { data: newUser, error: createError } = await supabase\n        .from('users')\n        .insert([\n          {\n            id: uuidv4(),\n            email,\n            created_at: new Date().toISOString(),\n          },\n        ])\n        .select();\n\n      if (createError || !newUser || newUser.length === 0) {\n        return res.status(500).json({ error: 'Failed to create user' });\n      }\n\n      userId = newUser[0].id;\n    } else {\n      userId = userData[0].id;\n    }\n\n    // Generate JWT token (simplified)\n    const token = Buffer.from(JSON.stringify({ userId, email })).toString('base64');\n\n    res.json({ token, userId, email });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Send message\napp.post('/api/messages/send', async (req: Request, res: Response) => {\n  try {\n    const { recipientId, ciphertext, nonce, ephemeralKey, messageHash } = req.body as MessageRequest;\n\n    if (!recipientId || !ciphertext || !nonce) {\n      return res.status(400).json({ error: 'Missing required fields' });\n    }\n\n    // Store message\n    const { data, error } = await supabase\n      .from('messages')\n      .insert([\n        {\n          id: uuidv4(),\n          recipient_id: recipientId,\n          ciphertext,\n          nonce,\n          ephemeral_key: ephemeralKey,\n          message_hash: messageHash,\n          created_at: new Date().toISOString(),\n        },\n      ])\n      .select();\n\n    if (error) {\n      return res.status(500).json({ error: 'Failed to send message' });\n    }\n\n    res.json({ message: 'Message sent', data });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Get messages\napp.get('/api/messages/:userId', async (req: Request, res: Response) => {\n  try {\n    const { userId } = req.params;\n\n    const { data, error } = await supabase\n      .from('messages')\n      .select('*')\n      .eq('recipient_id', userId)\n      .order('created_at', { ascending: false });\n\n    if (error) {\n      return res.status(500).json({ error: 'Failed to fetch messages' });\n    }\n\n    res.json({ messages: data });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Create SEAL\napp.post('/api/seals/create', async (req: Request, res: Response) => {\n  try {\n    const { messageCount, merkleRoot, messageHashes, signature } = req.body as SealRequest;\n\n    if (!messageCount || !merkleRoot || !signature) {\n      return res.status(400).json({ error: 'Missing required fields' });\n    }\n\n    // Store SEAL (insert-only)\n    const { data, error } = await supabase\n      .from('seals')\n      .insert([\n        {\n          id: uuidv4(),\n          message_count: messageCount,\n          merkle_root: merkleRoot,\n          message_hashes: messageHashes,\n          signature,\n          created_at: new Date().toISOString(),\n        },\n      ])\n      .select();\n\n    if (error) {\n      return res.status(500).json({ error: 'Failed to create SEAL' });\n    }\n\n    res.json({ seal: data });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Verify SEAL\napp.post('/api/seals/verify', async (req: Request, res: Response) => {\n  try {\n    const { sealId } = req.body;\n\n    if (!sealId) {\n      return res.status(400).json({ error: 'Seal ID is required' });\n    }\n\n    // Get SEAL\n    const { data, error } = await supabase\n      .from('seals')\n      .select('*')\n      .eq('id', sealId);\n\n    if (error || !data || data.length === 0) {\n      return res.status(404).json({ error: 'SEAL not found' });\n    }\n\n    res.json({ seal: data[0], verified: true });\n  } catch (error) {\n    console.error('Error:', error);\n    res.status(500).json({ error: 'Internal server error' });\n  }\n});\n\n// Start server\napp.listen(port, () => {\n  console.log(`SEAL Chat backend running on port ${port}`);\n  console.log(`Health check: http://localhost:${port}/health`);\n});\n"
