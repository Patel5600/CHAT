# SEAL Chat Backend\n\nProduction-grade backend for SEAL Chat with Supabase integration.\n\n## Setup\n\n1. **Install dependencies**\n   ```bash\n   npm install\n   ```\n\n2. **Configure Supabase**\n   - Create a Supabase project at https://supabase.com\n   - Get your `SUPABASE_URL` and `SUPABASE_KEY`\n   - Create database tables (see schema below)\n\n3. **Set environment variables**\n   ```bash\n   export SUPABASE_URL=\"your-url\"\n   export SUPABASE_KEY=\"your-key\"\n   export PORT=3000\n   ```\n\n4. **Run development server**\n   ```bash\n   npm run dev\n   ```\n\n5. **Build for production**\n   ```bash\n   npm run build\n   npm start\n   ```\n\n## Database Schema\n\n### users table\n```sql\nCREATE TABLE users (\n  id UUID PRIMARY KEY,\n  email VARCHAR(255) UNIQUE NOT NULL,\n  public_key TEXT,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### messages table\n```sql\nCREATE TABLE messages (\n  id UUID PRIMARY KEY,\n  recipient_id UUID REFERENCES users(id),\n  ciphertext TEXT NOT NULL,\n  nonce TEXT NOT NULL,\n  ephemeral_key TEXT NOT NULL,\n  message_hash TEXT NOT NULL,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### seals table (insert-only)\n```sql\nCREATE TABLE seals (\n  id UUID PRIMARY KEY,\n  message_count INTEGER NOT NULL,\n  merkle_root TEXT NOT NULL,\n  message_hashes TEXT[] NOT NULL,\n  signature TEXT NOT NULL,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Prevent updates and deletes\nCREATE POLICY \"seals_insert_only\" ON seals\n  AS PERMISSIVE FOR INSERT\n  WITH CHECK (true);\n\nCREATE POLICY \"seals_no_update\" ON seals\n  AS RESTRICTIVE FOR UPDATE\n  WITH CHECK (false);\n\nCREATE POLICY \"seals_no_delete\" ON seals\n  AS RESTRICTIVE FOR DELETE\n  WITH CHECK (false);\n```\n\n### otps table\n```sql\nCREATE TABLE otps (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  email VARCHAR(255) NOT NULL,\n  otp VARCHAR(6) NOT NULL,\n  expires_at TIMESTAMP NOT NULL,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n## API Endpoints\n\n### Health Check\n- `GET /health` - Server status\n\n### Authentication\n- `POST /api/auth/send-otp` - Send OTP to email\n- `POST /api/auth/verify-otp` - Verify OTP and get token\n\n### Messages\n- `POST /api/messages/send` - Send encrypted message\n- `GET /api/messages/:userId` - Get user's messages\n\n### SEALs\n- `POST /api/seals/create` - Create new SEAL\n- `POST /api/seals/verify` - Verify SEAL integrity\n\n## Security\n\n- All messages are end-to-end encrypted\n- SEALs are immutable (insert-only)\n- OTPs expire after 10 minutes\n- Row-level security policies enforce data isolation\n\n## Deployment\n\n### Heroku\n```bash\nheroku create seal-chat-backend\nheroku config:set SUPABASE_URL=\"your-url\"\nheroku config:set SUPABASE_KEY=\"your-key\"\ngit push heroku main\n```\n\n### Cloud Run\n```bash\ngcloud run deploy seal-chat-backend \\\n  --source . \\\n  --set-env-vars SUPABASE_URL=\"your-url\",SUPABASE_KEY=\"your-key\"\n```\n"
